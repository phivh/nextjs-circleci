version: 2.1
orbs:
  node: circleci/node@3.0.0
jobs:
  dep:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - restore_cache:
          keys:
          - node_modules-{{ checksum "package.json" }}
      - run:
          name: Install Dependencies
          command: npm install
      - save_cache:
          key: node_modules-{{ checksum "package.json" }}
          paths:
            - node_modules
  build:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - checkout
      - restore_cache:
          keys:
            - node_modules-{{ checksum "package.json" }}
      - run:
          name: Build 
          command: npm run build
  vpn_setup:
    machine:
      image: ubuntu-2004:202101-01
    steps:
      - run:
          name: Install OpenVPN
          command: |
            wget -O - https://swupdate.openvpn.net/repos/repo-public.gpg | sudo apt-key add -
            echo "deb http://build.openvpn.net/debian/openvpn/release/2.5 focal main" | sudo tee -a /etc/apt/sources.list.d/openvpn-aptrepo.list
            sudo apt-get update
            sudo apt-get install openvpn
      - run:
          name: VPN Setup
          background: true
          command: |
            echo $VPN_CLIENT_CONFIG | base64 --decode > /tmp/config.ovpn
            printf "user\n$VPN_PASSWORD" > /tmp/vpn.login
            wget -qO- http://checkip.amazonaws.com | tee initial.ip
            sudo openvpn --config /tmp/config.ovpn --auth-user-pass /tmp/vpn.login > openvpn.log 2>&1 &
            while [ -n "$(ip addr show tun0 2>&1 > /dev/null)" ]; do
              sleep 0.1;
            done
            cat openvpn.log
            wget -qO- http://checkip.amazonaws.com | tee final.ip
            if [ "$(cat initial.ip)" == "$(cat final.ip)" ]
            then
              echo "This computer's apparent public IP address was not different after connecting"
              echo "This may mean that your VPN is not configured correctly."
              exit 1
            fi
  deploy_dev:
     machine:
       enabled: true
     steps:
       - run:
           name: Deploy Over SSH
           command: |
             scp -r /home/circleci/project/dist/* $SSH_USER@$SSH_HOST:~/resource/nextjs-circleci/dist
       - run:
          name: Disconnect from OpenVPN
          command: sudo killall openvpn || true
          when: always
       - run:
          name: remove OpenVPN config
          command: sudo rm /tmp/config.ovpn
workflows:
   version: 2
   build-and-deploy:
     jobs:
       - vpn_setup